/*
 * This file was generated by the Gradle 'init' task.
 *
 * This generated file contains a sample Java application project to get you started.
 * For more details take a look at the 'Building Java & JVM projects' chapter in the Gradle
 * User Manual available at https://docs.gradle.org/6.7/userguide/building_java_projects.html
 */

plugins {
    id 'java'
    id 'groovy'
    id 'application'
    id 'org.graalvm.buildtools.native' version '0.9.28'
    id 'maven-publish'
}

// read the version from the `VERSION` file
version = new File(rootDir,'VERSION').text.trim()
group = 'io.seqera'

java {
    toolchain {
        languageVersion = JavaLanguageVersion.of(17)
    }

    compileJava {
        // Set binary compatibility for Java compiler to 17
        options.release.set(17)
    }
}

repositories {
    mavenCentral()
}

def nativeCliTest = sourceSets.create('nativeCliTest')

configurations[nativeCliTest.implementationConfigurationName].extendsFrom(configurations.testImplementation)
configurations[nativeCliTest.runtimeOnlyConfigurationName].extendsFrom(configurations.testRuntimeOnly)


dependencies {
    implementation platform("io.micronaut.platform:micronaut-platform:$micronautVersion")
    implementation 'io.micronaut:micronaut-inject-groovy'

    // This dependency is used by the application.
    implementation "ch.qos.logback:logback-classic"
    runtimeOnly 'mysql:mysql-connector-java:8.0.22'
    runtimeOnly 'com.h2database:h2:1.4.200'
    runtimeOnly 'mysql:mysql-connector-java:8.0.28'
    runtimeOnly 'org.xerial:sqlite-jdbc:3.45.0.0'
    implementation 'info.picocli:picocli:4.6.3'
    annotationProcessor 'info.picocli:picocli-codegen:4.6.3'
    implementation 'org.apache.groovy:groovy-sql'

    // Use the latest Groovy version for Spock testing
    testImplementation platform("io.micronaut.platform:micronaut-platform:$micronautVersion")
    testImplementation 'org.apache.groovy:groovy-nio'
    testImplementation "io.micronaut:micronaut-inject-groovy"
    testImplementation "io.micronaut.test:micronaut-test-spock"
    testImplementation "org.spockframework:spock-core"
    testImplementation "org.spockframework:spock-junit4"  // you can remove this if your code does not rely on old JUnit 4 rules
    testImplementation 'junit:junit:4.13'
    testImplementation "org.testcontainers:testcontainers"
    testImplementation "org.testcontainers:mysql"
    testImplementation "org.testcontainers:spock"

    // Dummy library containing some migration files among their resources for testing purposes
    testImplementation files("libs/jar-with-resources.jar")

    nativeCliTestImplementation project
    nativeCliTestImplementation 'org.apache.groovy:groovy-sql'
}

test {
    useJUnitPlatform()
}

application {
    // Define the main class for the application.
    mainClass = 'io.seqera.migtool.App'
    applicationDefaultJvmArgs = ["-agentlib:native-image-agent=config-merge-dir=conf/"]
}

ext.aws_access_key_id = project.findProperty('aws_access_key_id') ?: System.getenv('AWS_ACCESS_KEY_ID')
ext.aws_secret_access_key = project.findProperty('aws_secret_access_key') ?: System.getenv('AWS_SECRET_ACCESS_KEY')
ext.publishRepoUrl = project.findProperty('publish_repo_url') ?: System.getenv('PUBLISH_REPO_URL') ?: ( version.endsWith('-SNAPSHOT') ? "s3://maven.seqera.io/snapshots" : "s3://maven.seqera.io/releases" )

// Add sources to JARs.
jar {
    from sourceSets.main.allSource
}

publishing {
    publications {
        mavenJava(MavenPublication) {
            from components.java
        }
    }
    repositories {
        maven {
            url = publishRepoUrl
            credentials(AwsCredentials) {
                // keys are defined in the `gradle.properties` file
                accessKey aws_access_key_id
                secretKey aws_secret_access_key
            }
        }
    }
}

/** Define a duplication strategy for `jar` tasks.
 *  Prevents error "Entry <filename> is a duplicate but no duplicate handling strategy has been set"
 *  since Gradle 7 (https://github.com/gradle/gradle/issues/17236).
 */
tasks.withType(Jar) {
    duplicatesStrategy = DuplicatesStrategy.INCLUDE
}

graalvmNative {
    binaries {
        main {
            imageName = 'migtool'
            mainClass = 'io.seqera.migtool.App'
            configurationFileDirectories.from(file('conf'))


            buildArgs(org.gradle.nativeplatform.platform.internal.DefaultNativePlatform.currentOperatingSystem.isLinux() ? ['--static', ] : [])
            buildArgs.add('--allow-incomplete-classpath')
            buildArgs.add('--report-unsupported-elements-at-runtime')
            buildArgs.add('--initialize-at-run-time=sun.nio.ch.WindowsAsynchronousFileChannelImpl$DefaultIocpHolder')
            buildArgs.add('-H:+AddAllCharsets')
            buildArgs.add('-H:EnableURLProtocols=https,http')
            buildArgs.add('-H:+ReportExceptionStackTraces')
            buildArgs.add('-H:-CheckToolchain')
            buildArgs.add('-H:IncludeResources=.*/TlsSettings.properties$')
            buildArgs.add('-H:+StaticExecutableWithDynamicLibC')
            buildArgs.add('-H:+PrintClassInitialization')

            javaLauncher = javaToolchains.launcherFor {
                languageVersion = JavaLanguageVersion.of(17)
            }
        }
    }
}

def nativeCliTestTask = tasks.register('nativeCliTest', Test) {
    description = 'Runs nativeCli tests.'
    group = 'verification'
    useJUnitPlatform()

    testClassesDirs = nativeCliTest.output.classesDirs
    classpath = configurations[nativeCliTest.runtimeClasspathConfigurationName] + nativeCliTest.output

    dependsOn nativeCompile
    environment 'NATIVE_BINARY_PATH', "$buildDir/native/nativeCompile/migtool"
}

tasks.named('check') {
    dependsOn(nativeCliTestTask)
}
